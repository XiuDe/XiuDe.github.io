---
layout: original
title: 关于ajax
date: 2017-10-21 11:19:49 +0800 
categories: 前端框架研究
tag: ajax
---
* content
{:toc}

框架的ajax用多了，敲原生ajax出错了，整合一下。
- 过时的iframe隐藏帧技术
- ajax原生
- js运行机制
    + - [阮一峰老师写的js的运行机制事件循环(包括nodejs的)](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)

<!-- more -->

## iframe隐藏帧实现页面局部更新
- 在浏览器兼容ajax之前的技术
- iframe就相当于页面的子页面
- 不是异步请求

```
// 登录页面
    <div>
        <form action="./iframe.php" method="post" target="myframe">
            用户名：<input type="text" name="username"><span id="info"></span><br>
            密码：<input type="text" name="password">
            <input type="submit" value="登录">
        </form>
    </div>
    <iframe width="0" height="0"  frameborder="0" name="myframe"></iframe>


// 后台
<?php 
$uname = $_POST['username'];
$pw = $_POST['password'];

// if($uname == 'admin' && $pw == '123'){
//     echo '登录成功';
// }


if($uname == 'admin' && $pw == '123'){
?>
    <script type="text/javascript">
        // parent子页面的父页面
        parent.document.getElementById('info').innerHTML = '登录成功';
    </script>
<?php }else{ ?>
    <script type="text/javascript">
        parent.document.getElementById('info').innerHTML = '登录失败';
    </script>
<?php } ?>    
```

## 原生ajax代码案例

```
        var btn = document.getElementById('btn');
        btn.onclick = function(){
            var uname = document.getElementById('username').value;
            var pw = document.getElementById('password').value;

            // 使用Ajax发送请求：
            // 1、创建XMLHttpRequest对象
            var xhr = null;
            if(window.XMLHttpRequest){
                xhr = new XMLHttpRequest();//标准
            }else{
                xhr = new ActiveXObject("Microsoft");//IE6
            }
            // readyState=0表示xhr对象创建完成
            console.log(xhr.readyState + '----------1-----------');//0


            // 2、准备发送
            /*
            参数一：请求方式（get获取数据；post提交数据）
            参数二：请求地址
            参数三：同步或者异步标志位，默认是true表示异步，false表示同步
                    false的应用场景很少见。

            如果是get请求那么请求参数必须在url中传递
            encodeURI()用来对中文参数进行编码，防止乱码，
            IE中极易出现乱码

            post请求参数通过send传递，不需要通过encodeURI()转码
            必须设置请求头信息
            xhr.open('post','04post.php',true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            xhr.send(param);//post请求参数在这里传递，并且不需要转码
            */
            var param = 'username='+uname+'&password='+pw;
            xhr.open('get','03get.php?'+encodeURI(param),true);
            
            // 3、执行发送动作
            xhr.send(null);
            // readyState=1表示已经发送了请求
            console.log(xhr.readyState + '----------2-----------');//1
            // 该函数调用的条件就是readyState状态发生变化（不包括从0变为1）

            // 4、指定回调函数
            xhr.onreadystatechange = function(){
                /*
                readyState:
                2 浏览器已经收到了服务器响应的数据
                3 正在解析数据
                4 数据已经解析完成，可以使用了
                */
                console.log(xhr.readyState + '----------3-----------');// 2 3 4
                // 4表示服务器返回的数据已经可以使用了，但是这个数据不一定是正常的
                if(xhr.readyState == 4){
                    if(xhr.status == 200){
                    // http的常见状态码
                    /*
                    200表示响应成功
                    404没有找到请求的资源
                    500服务器端错误
                    */
                    // 200表示服务器返回的数据是正常的，不是200的话表示数据是错误的
                        var data = xhr.responseText;
                        // 解析之前的XML格式数据
                        // var data = xhr.responseXML;
                        var info = document.getElementById('info');
                        if(data == '1'){
                            info.innerHTML = '登录成功';
                        }else if(data == '2'){
                            info.innerHTML = '用户名或者密码错误';
                        }
                    }
                }
            }
        }
```

## 原生ajax请求data.json数据
- json数据和js对象的区别
    + json数据没有变量
    + json形式的数据结尾没有分号
    + json数据中的键必须用双引号包住
    + 数组是json格式的特例

```
// 标准json数据
{
    "name":"zhansan",
    "age":12,
    "lover":["coding","swimming","singing"],
    "friend":{
        "high":"180cm",
        "weight":"80kg",
        "lover":["swimming","singing","dancing"],
        "friend":{}
    }
}
```

- 原生ajax对json的解析
    + `JSON.parse()`将json数据转换为对象或者是将字符串转换为对象
    + `JSON.stringify()`将对象转换为字符串
    + `eval("(" + data + ")")`eval的作用就是把字符串解析成js代码并执行，存在安全隐患，
    + `eval()`里的()必须加，否则会报错

```
var data = xhr.responseText;// 如果返回的是json格式
var data = JSON.parse(data);// 转换借助JSON.parse()方法
                            // 将json形式的字符串转化为对象

// 读取数据
console.log(d.name);
console.log(d.age);
console.log(d.friend.high);
console.log(d.friend.weight);
console.log(d.friend.lover);
```

## 原生ajax同步与异步
- w3school点击左侧标签，页面全部刷新，是同步方式(阻塞)
- 一般的评论加载更多，异步加载(非阻塞)

## 浏览器ajax请求数据
1. 浏览器声明的xhr对象，让xhr向服务器要数据
2. 浏览器继续执行其他的代码
3. xhr对象请求服务器
4. 服务器将数据给xhr
5. xhr通知浏览器数据回来了
6. 浏览器处理xhr返回的数据渲染页面

## 同步与异步底层原理分析
### 1.js中的事件处理机制(涉及到异步效果)的有：
1. 定时函数`setTimeOut()`和`setInterval()`。
2. 事件函数(给DOM绑定的事件)。
3. ajax回调函数`xhr.onreadystatechange=function(){}`。

### 2.js的运行机制：单线程 + 事件队列
- [阮一峰老师写的js的运行机制事件循环(包括nodejs的)](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)

> 简单概括

```
单线程：代码从上到下依次执行。
事件队列：
        当js解析器执行到某种情况的时候，会把相应的任务，放到事件队列中(事件队列放的就是回调函数)然后再执行其后的代码。
        当单线程运行结束之后，浏览器提供了另外的机制-->事件循环(单独的事件循环进程)，
        即单线程运行结束之后判断事件队列中有没有任务，有任务的话就把任务取出来放到主线程当中执行，并且放到主线程过程中要判断两个条件：
        ① 主线程现在是空闲了，没有干其他的事情。
        ② 事件队列当中的任务满足了触发条件：
            定时函数（延时时间）
            DOM的事件函数（触发条件）
            ajax的回调函数（服务器端有数据响应）
```

## jQuery中的ajax浅析

```
    $(function(){
        $("#btn").click(function(){
            var code = $("#code").val();
            $.ajax({
                type:'get',
                url:'./11.php',
                data:{code:code},// 将参数放在url上传递url: '
                                 // ./11.php?code=' + code,
                dataType:'json', // xml json text html script jsonp
                success:function(data){
                    //逻辑处理
                },
                error:function(data){
                    console.dir(data);
                    $("#info").html("服务器发生错误，请与管理员联系");
                }
            });
        });
    });
```

### 模仿jquery封装ajax

```

function ajax(obj){
    // 默认参数
    var defaults = {
        type : 'get',
        data : {},
        url : '#',
        dataType : 'text',
        async : true,
        success : function(data){console.log(data)}
    }
    // 处理形参，传递参数的时候就覆盖默认参数，不传递就使用默认参数
    for(var key in obj){
        defaults[key] = obj[key];
    }
    // 1、创建XMLHttpRequest对象
    var xhr = null;
    if(window.XMLHttpRequest){
        xhr = new XMLHttpRequest();
    }else{
        xhr = new ActiveXObject('Microsoft.XMLHTTP');
    }
    // 把对象形式的参数转化为字符串形式的参数
    /*
    {username:'zhangsan','password':123}
    转换为
    username=zhangsan&password=123
    */
    var param = '';
    for(var attr in obj.data){
        param += attr + '=' + obj.data[attr] + '&';
    }
    if(param){
        param = param.substring(0,param.length - 1);
    }
    // 处理get请求参数并且处理中文乱码问题
    if(defaults.type == 'get'){
        defaults.url += '?' + encodeURI(param);
    }
    // 2、准备发送（设置发送的参数）
    xhr.open(defaults.type,defaults.url,defaults.async);
    // 处理post请求参数并且设置请求头信息（必须设置）
    var data = null;
    if(defaults.type == 'post'){
        data = param;
        xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    }
    // 3、执行发送动作
    xhr.send(data);
    // 处理同步请求，不会调用回调函数
    if(!defaults.async){
        if(defaults.dataType == 'json'){
            return JSON.parse(xhr.responseText);
        }else{
            return xhr.responseText;
        }
    }
    // 4、指定回调函数（处理服务器响应数据）
    xhr.onreadystatechange = function(){
        if(xhr.readyState == 4){
            if(xhr.status == 200){
                var data = xhr.responseText;
                if(defaults.dataType == 'json'){
                    // data = eval("("+ data +")");
                    data = JSON.parse(data);
                }
                defaults.success(data);
            }
        }
    }

}
```
